@using MRBooker.Data.ReservationViewModels

@model ReservationViewModel

@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-2">
        <form method="get">
            <h2>Rooms</h2>
            <div>
                <select asp-for="RoomId" asp-items="@Model.Rooms" class="form-control"></select>
                <input type="hidden" id="roomId" name="roomId" value="0" />
                <input type="hidden" id="roomName" name="roomName" value="" />
            </div>
        </form>
    </div>

    <div class="col-md-6">
        <div id="main_scheduler" class="dhx_cal_container" style="width: 100%; height: 100%; padding: 100%;">
            <div class="dhx_cal_navline">
                <div class="dhx_cal_prev_button">&nbsp;</div>
                <div class="dhx_cal_next_button">&nbsp;</div>
                <div class="dhx_cal_today_button"></div>
                <div class="dhx_cal_date"></div>
                <div class="dhx_cal_tab" name="day_tab" style="right: 204px;"></div>
                <div class="dhx_cal_tab" name="week_tab" style="right: 140px;"></div>
                <div class="dhx_cal_tab" name="month_tab" style="right: 76px;"></div>
            </div>
            <div class="dhx_cal_header"></div>
            <div class="dhx_cal_data"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            $("#RoomId").change(function () {
                var roomid = $('#RoomId option:selected').val();
                setRoom(roomid);
            });

            function setRoom(roomid) {
                $('#roomId').val(roomid)
                    .trigger('change');
            }

            scheduler.config.xml_date = "%Y/%m/%d %h:%i:%s";
            
            scheduler.config.server_utc = true;
            scheduler.config.readonly = false;
            
            var selectedRoom = [
                { key: $('#RoomId option:selected').val(), label: $('#RoomId option:selected').text() }
            ];
            var lbSections = [
                { name: "Title", height: 30, map_to: "title", type: "textarea", focus: true },
                { name: "Description", height: 30, map_to: "description", type: "textarea", focus: true },
                { name: "Status", height: 30, map_to: "status", type: "textarea", focus: true },
                { name: "room", height: 58, options: selectedRoom, map_to: "room", type: "radio", vertical: true },
                { name: "time", height: 72, type: "time", map_to: "auto", time_format: ["%H:%i", "%d", "%m", "%Y"] }
            ];

            scheduler.templates.event_bar_text = function (start, end, ev) {
                return ev.title;
            };
            scheduler.locale.labels.section_room = 'Room';
            scheduler.config.lightbox.sections = lbSections;

            scheduler.init('main_scheduler', new Date(), "month");
            $('#roomId').change(function () {
                scheduler.load("api/reservationApi/GetReservationByRoom/?roomId=" + $('#roomId').val(), "json");
                scheduler.clearAll();
                scheduler.setCurrentView();
                selectedRoom =
                    [{ key: $('#RoomId option:selected').val(), label: $('#RoomId option:selected').text() }];
                lbSections = [
                    { name: "Title", height: 30, map_to: "title", type: "textarea", focus: true },
                    { name: "Description", height: 30, map_to: "description", type: "textarea", focus: true },
                    { name: "Status", height: 30, map_to: "status", type: "textarea", focus: true },
                    {
                        name: "room",
                        height: 58,
                        options: selectedRoom,
                        map_to: "roomid",
                        type: "radio",
                        vertical: true
                    },
                    { name: "time", height: 72, type: "time", map_to: "auto", time_format: ["%H:%i", "%d", "%m", "%Y"]  }
                ];
            });
            
            scheduler.attachEvent("onBeforeLightbox",
                function (id) {
                    if ($('#RoomId option:selected').text() === "All Rooms") {
                        dhtmlx.message({
                            title: "Room",
                            type: "alert-warning",
                            text: "Please select a room before reservation",
                            callback: function() {
                                scheduler.endLightbox(true, document.getElementsByClassName('dhx_cal_light_wide')[0]);
                            }
                        });
                    }
                    
                    scheduler.resetLightbox();
                    scheduler.config.lightbox.sections = lbSections;
                    return true;
                });
            
            scheduler.attachEvent("onEventSave",
                function (id, ev, is_new) {
                    if (is_new) {
                        $.ajax({
                            url: "api/reservationApi/insert",
                            type: "POST",
                            contentType: 'application/json; charset=utf-8',
                            data: JSON.stringify(ev),
                            success: function() {
                                dhtmlx.message({
                                    title: "Reservation",
                                    type: "alert-warning",
                                    text: "Reservation has been saved.",
                                    callback: function () { scheduler.endLightbox(true, document.getElementsByClassName('dhx_cal_light_wide')[0])}
                                });
                                scheduler.clearAll();
                                scheduler.setCurrentView();
                            },
                            error: function() {
                                console.log('error !' + ev);
                                return false;
                            }
                        });
                    } else {
                        $.ajax({
                            url: "api/reservationApi/update",
                            type: "PUT",
                            contentType: 'application/json; charset=utf-8',
                            data: JSON.stringify(ev),
                            success: function (ev) {
                                dhtmlx.message({
                                    title: "Reservation",
                                    type: "alert-warning",
                                    text: "Reservation has been updated.",
                                    callback: function () { scheduler.endLightbox(true, document.getElementsByClassName('dhx_cal_light_wide')[0]) }
                                });
                                scheduler.clearAll();
                                scheduler.setCurrentView();
                            },
                            error: function () {
                                console.log('error !' + ev);
                                return false;
                            }
                        });
                    }
                });

            scheduler.attachEvent("onEventChanged",
                function (id, ev) {
                    $.ajax({
                        url: "api/reservationApi/update",
                        type: "PUT",
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(ev),
                        success: function (ev) {
                            console.log('success !' + ev);
                            return true;
                        },
                        error: function () {
                            console.log('error !' + ev);
                            return false;
                        }
                    });
                });

            scheduler.attachEvent("onEventDeleted",
                function (id) {
                    $.ajax({
                        url: "api/reservationApi/delete/?=" + id,
                        type: "DELETE",
                        contentType: 'application/json; charset=utf-8',
                        success: function (response) {
                            console.log('success !' + response);
                            return true;
                        },
                        error: function () {
                            console.log('error !' + response);
                            return false;
                        }
                    });
                });
            scheduler.load("api/reservationApi/GetAll", "json");
        });
    </script>

}
@*<environment include="Development">
        <script src="~/js/scheduler.js.js" asp-append-version="true"></script>
    </environment>*@

@*<style type="text/css" media="screen">
        html, body {
            margin: 0px;
            padding: 0px;
            height: 100%;
            overflow: hidden;
        }
    </style>*@
